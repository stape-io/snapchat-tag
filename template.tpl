___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Snapchat Conversion API",
  "categories": [
    "ADVERTISING",
    "ANALYTICS",
    "CONVERSIONS",
    "MARKETING",
    "REMARKETING"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "Stape",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Tag that send the event data from the Universal Analytics/GA4/Data client to Snapchat Conversion API.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "RADIO",
    "name": "eventType",
    "displayName": "Event Name Setup Method",
    "radioItems": [
      {
        "value": "standard",
        "displayValue": "Standard",
        "subParams": [
          {
            "type": "SELECT",
            "name": "eventNameStandard",
            "selectItems": [
              {
                "value": "PURCHASE",
                "displayValue": "PURCHASE"
              },
              {
                "value": "PAGE_VIEW",
                "displayValue": "PAGE_VIEW"
              },
              {
                "value": "LIST_VIEW",
                "displayValue": "LIST_VIEW"
              },
              {
                "value": "VIEW_CONTENT",
                "displayValue": "VIEW_CONTENT"
              },
              {
                "value": "ADD_CART",
                "displayValue": "ADD_CART"
              },
              {
                "value": "START_CHECKOUT",
                "displayValue": "START_CHECKOUT"
              },
              {
                "value": "ADD_BILLING",
                "displayValue": "ADD_BILLING"
              },
              {
                "value": "LOGIN",
                "displayValue": "LOGIN"
              },
              {
                "value": "SIGN_UP",
                "displayValue": "SIGN_UP"
              },
              {
                "value": "SEARCH",
                "displayValue": "SEARCH"
              },
              {
                "value": "ADD_TO_WISHLIST",
                "displayValue": "ADD_TO_WISHLIST"
              },
              {
                "value": "SUBSCRIBE",
                "displayValue": "SUBSCRIBE"
              },
              {
                "value": "SAVE",
                "displayValue": "SAVE"
              },
              {
                "value": "AD_CLICK",
                "displayValue": "AD_CLICK"
              },
              {
                "value": "AD_VIEW",
                "displayValue": "AD_VIEW"
              },
              {
                "value": "COMPLETE_TUTORIAL",
                "displayValue": "COMPLETE_TUTORIAL"
              },
              {
                "value": "INVITE",
                "displayValue": "INVITE"
              },
              {
                "value": "SHARE",
                "displayValue": "SHARE"
              },
              {
                "value": "RESERVE",
                "displayValue": "RESERVE"
              },
              {
                "value": "ACHIEVEMENT_UNLOCKED",
                "displayValue": "ACHIEVEMENT_UNLOCKED"
              },
              {
                "value": "SPENT_CREDITS",
                "displayValue": "SPENT_CREDITS"
              },
              {
                "value": "RATE",
                "displayValue": "RATE"
              },
              {
                "value": "START_TRIAL",
                "displayValue": "START_TRIAL"
              },
              {
                "value": "APP_INSTALL",
                "displayValue": "APP_INSTALL"
              },
              {
                "value": "APP_OPEN",
                "displayValue": "APP_OPEN"
              },
              {
                "value": "CUSTOM_EVENT_1",
                "displayValue": "CUSTOM_EVENT_1"
              },
              {
                "value": "CUSTOM_EVENT_2",
                "displayValue": "CUSTOM_EVENT_2"
              },
              {
                "value": "CUSTOM_EVENT_3",
                "displayValue": "CUSTOM_EVENT_3"
              },
              {
                "value": "CUSTOM_EVENT_4",
                "displayValue": "CUSTOM_EVENT_4"
              },
              {
                "value": "CUSTOM_EVENT_5",
                "displayValue": "CUSTOM_EVENT_5"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "PURCHASE",
            "displayName": "Event Name",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "alwaysInSummary": true
          }
        ]
      },
      {
        "value": "inherit",
        "subParams": [],
        "displayValue": "Inherit from client"
      },
      {
        "value": "custom",
        "subParams": [
          {
            "type": "TEXT",
            "name": "eventNameCustom",
            "displayName": "",
            "simpleValueType": true
          }
        ],
        "displayValue": "Custom"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "standard"
  },
  {
    "type": "SELECT",
    "name": "eventConversionType",
    "displayName": "Event Conversion Type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "WEB",
        "displayValue": "Web"
      },
      {
        "value": "OFFLINE",
        "displayValue": "Offline"
      },
      {
        "value": "MOBILE_APP",
        "displayValue": "Mobile App"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "WEB",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "pixelId",
    "displayName": "Pixel ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Set to a valid Pixel ID. You can only add a single Pixel ID per tag.",
    "enablingConditions": [
      {
        "paramName": "eventConversionType",
        "paramValue": "MOBILE_APP",
        "type": "NOT_EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "appId",
    "displayName": "App ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "The unique ID (app_id) assigned for a given application. It should be numeric for iOS, and the human interpretable string (example: com.snapchat.android) for Android. Required for app events.",
    "enablingConditions": [
      {
        "paramName": "eventConversionType",
        "paramValue": "MOBILE_APP",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "snapAppId",
    "displayName": "Snap App ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "The Snap App ID associated with your app (a unique code generated in Ads Manager and included in your MMP dashboard).",
    "enablingConditions": [
      {
        "paramName": "eventConversionType",
        "paramValue": "MOBILE_APP",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "accessToken",
    "displayName": "Access Token",
    "simpleValueType": true,
    "help": "More info on how to get Access Token \u003ca target\u003d\"_blank\" href\u003d\"https://docs.snap.com/api/marketing-api/Conversions-API/GetStarted#access-token\"\u003ecan be found by this link\u003c/a\u003e.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "useHttpOnlyCookie",
    "checkboxText": "Use HttpOnly cookies",
    "simpleValueType": true,
    "help": "Forbids JavaScript from accessing the cookie if enabled."
  },
  {
    "type": "CHECKBOX",
    "name": "useOptimisticScenario",
    "checkboxText": "Use Optimistic Scenario",
    "simpleValueType": true,
    "help": "The tag will call gtmOnSuccess() without waiting for a response from the API. This will speed up sGTM response time however your tag will always return the status fired successfully even in case it is not."
  },
  {
    "type": "CHECKBOX",
    "name": "notSetClickIdCookie",
    "checkboxText": "Do not set Click ID (_scclid) cookie",
    "simpleValueType": true,
    "help": "Do not set Click ID (_scclid) cookie if it was added to user data.",
    "defaultValue": false
  },
  {
    "type": "CHECKBOX",
    "name": "notSetBrowserIdCookie",
    "checkboxText": "Do not set Browser ID (_scid) cookie",
    "simpleValueType": true,
    "help": "Do not set Browser ID (_scid) cookie if it was added to user data.",
    "defaultValue": false
  },
  {
    "type": "CHECKBOX",
    "name": "validate",
    "checkboxText": "Test Mode",
    "simpleValueType": true,
    "help": "If enabled conversion request will be sent to /v3/{{asset_id}}/events/validate \u003ca href\u003d\"https://docs.snap.com/api/marketing-api/Conversions-API/VerifySetUp\"\u003emore info\u003c/a\u003e"
  },
  {
    "displayName": "Server Parameters",
    "name": "serverDataListGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "serverDataList",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "event_id",
            "displayName": "Name",
            "name": "name",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "event_id",
                "displayValue": "Event ID"
              },
              {
                "value": "event_source_url",
                "displayValue": "Event Source URL"
              },
              {
                "value": "data_processing_options",
                "displayValue": "Data Processing Options"
              },
              {
                "value": "test_event_code",
                "displayValue": "Test Event Code"
              },
              {
                "value": "event_time",
                "displayValue": "Event Time"
              }
            ],
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "newRowButtonText": "Add property"
      }
    ]
  },
  {
    "displayName": "User Data Parameters",
    "name": "userDataListGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "LABEL",
        "name": "userDataLabel",
        "displayName": "All parameters in this section will be automatically hashed if they are not hashed."
      },
      {
        "name": "userDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "em",
            "displayName": "Property Name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT",
            "selectItems": [
              {
                "value": "em",
                "displayValue": "Email"
              },
              {
                "value": "ph",
                "displayValue": "Phone Number"
              },
              {
                "value": "client_ip_address",
                "displayValue": "IP Address"
              },
              {
                "value": "madid",
                "displayValue": "MAID (IDFA or AAID)"
              },
              {
                "value": "idfv",
                "displayValue": "IDFV"
              },
              {
                "value": "fn",
                "displayValue": "First Name"
              },
              {
                "value": "ln",
                "displayValue": "Last Name"
              },
              {
                "value": "ct",
                "displayValue": "City"
              },
              {
                "value": "st",
                "displayValue": "State"
              },
              {
                "value": "zp",
                "displayValue": "Zip"
              },
              {
                "value": "country",
                "displayValue": "Country"
              },
              {
                "value": "external_id",
                "displayValue": "External ID"
              },
              {
                "value": "subscription_id",
                "displayValue": "Subscription ID"
              },
              {
                "value": "lead_id",
                "displayValue": "Lead ID"
              },
              {
                "value": "anon_id",
                "displayValue": "Anon id"
              },
              {
                "value": "download_id",
                "displayValue": "Download ID"
              },
              {
                "value": "client_user_agent",
                "displayValue": "User Agent"
              },
              {
                "value": "sc_click_id",
                "displayValue": "Click ID"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add property"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "appDataListGroup",
    "displayName": "App Data Parameters",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "appDataList",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "extinfo",
            "displayName": "Name",
            "name": "name",
            "type": "SELECT",
            "isUnique": true,
            "selectItems": [
              {
                "value": "extinfo",
                "displayValue": "Extinfo"
              },
              {
                "value": "advertiser_tracking_enabled",
                "displayValue": "Advertiser Tracking Enabled"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "newRowButtonText": "Add property"
      }
    ]
  },
  {
    "displayName": "Custom Data Parameters",
    "name": "customDataListGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "LABEL",
        "name": "сustomDataLabel",
        "displayName": "See \u003ca href\u003d\"https://docs.snap.com/api/marketing-api/Conversions-API/Parameters\" target\u003d\"_blank\"\u003ethis documentation\u003c/a\u003e for more details on what data parameters you can add to the call."
      },
      {
        "name": "customDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "",
            "displayName": "Property Name",
            "name": "name",
            "isUnique": true,
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add property"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "consentSettingsGroup",
    "displayName": "Consent Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "adStorageConsent",
        "displayName": "",
        "radioItems": [
          {
            "value": "optional",
            "displayValue": "Send data always"
          },
          {
            "value": "required",
            "displayValue": "Send data in case marketing consent given"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "optional"
      }
    ]
  },
  {
    "displayName": "Logs Settings",
    "name": "logsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const getAllEventData = require('getAllEventData');
const JSON = require('JSON');
const sendHttpRequest = require('sendHttpRequest');
const getTimestampMillis = require('getTimestampMillis');
const setCookie = require('setCookie');
const getCookieValues = require('getCookieValues');
const getContainerVersion = require('getContainerVersion');
const logToConsole = require('logToConsole');
const sha256Sync = require('sha256Sync');
const makeString = require('makeString');
const getRequestHeader = require('getRequestHeader');
const getType = require('getType');
const Math = require('Math');
const generateRandom = require('generateRandom');
const parseUrl = require('parseUrl');
const makeNumber = require('makeNumber');
const encodeUriComponent = require('encodeUriComponent');

const containerVersion = getContainerVersion();
const isDebug = containerVersion.debugMode;
const isLoggingEnabled = determinateIsLoggingEnabled();
const traceId = getRequestHeader('trace-id');

const eventData = getAllEventData();
const url = eventData.page_location || getRequestHeader('referer');

if (!isConsentGivenOrNotRequired()) {
  return data.gtmOnSuccess();
}

if (url && url.lastIndexOf('https://gtm-msr.appspot.com/', 0) === 0) {
  return data.gtmOnSuccess();
}

const pixelOrAppId = data.eventConversionType === 'MOBILE_APP' ? data.snapAppId : data.pixelId;
if (!pixelOrAppId || !data.accessToken) {
  return data.gtmOnFailure();
}

const commonCookie = eventData.common_cookie || {};

sendTrackRequest(mapEvent(eventData, data));

function sendTrackRequest(mappedEvent) {
  const postBody = {
    data: [mappedEvent]
  };
  const postUrl = getPostUrl();

  if (isLoggingEnabled) {
    logToConsole(
      JSON.stringify({
        Name: 'Snapchat',
        Type: 'Request',
        TraceId: traceId,
        EventName: mappedEvent.event_name,
        RequestMethod: 'POST',
        RequestUrl: postUrl,
        RequestBody: postBody
      })
    );
  }

  const cookieOptions = {
    domain: 'auto',
    path: '/',
    samesite: 'Lax',
    secure: true,
    'max-age': 31536000, // 1 year
    httpOnly: !!data.useHttpOnlyCookie
  };

  if (mappedEvent.user_data.sc_click_id && !data.notSetClickIdCookie) {
    setCookie('_scclid', mappedEvent.user_data.sc_click_id, cookieOptions);
  }

  if (mappedEvent.user_data.sc_cookie1 && !data.notSetBrowserIdCookie) {
    setCookie('_scid', mappedEvent.user_data.sc_cookie1, cookieOptions);
  }

  sendHttpRequest(
    postUrl,
    (statusCode, headers, body) => {
      if (isLoggingEnabled) {
        logToConsole(
          JSON.stringify({
            Name: 'Snapchat',
            Type: 'Response',
            TraceId: traceId,
            EventName: mappedEvent.event_name,
            ResponseStatusCode: statusCode,
            ResponseHeaders: headers,
            ResponseBody: body
          })
        );
      }
      if (!data.useOptimisticScenario) {
        if (statusCode >= 200 && statusCode < 400) {
          data.gtmOnSuccess();
        } else {
          data.gtmOnFailure();
        }
      }
    },
    {
      headers: {
        'Content-Type': 'application/json'
      },
      method: 'POST'
    },
    JSON.stringify(postBody)
  );
}

if (data.useOptimisticScenario) {
  data.gtmOnSuccess();
}

function getPostUrl() {
  let postUrl = 'https://tr.snapchat.com/v3/' + encodeUriComponent(pixelOrAppId) + '/events';
  if (data.validate) {
    postUrl = postUrl + '/validate';
  }
  postUrl = postUrl + '?access_token=' + data.accessToken;
  return postUrl;
}

function getEventName(eventData, data) {
  if (data.eventType === 'inherit') {
    let eventName = eventData.event_name;

    let gaToEventName = {
      page_view: 'PAGE_VIEW',
      'gtm.dom': 'PAGE_VIEW',
      add_to_cart: 'ADD_CART',
      sign_up: 'SIGN_UP',
      purchase: 'PURCHASE',
      view_item: 'VIEW_CONTENT',
      add_to_wishlist: 'ADD_TO_WISHLIST',
      begin_checkout: 'START_CHECKOUT',
      add_payment_info: 'ADD_BILLING',
      view_item_list: 'LIST_VIEW',
      tutorial_complete: 'COMPLETE_TUTORIAL',
      search: 'SEARCH',
      generate_lead: 'SIGN_UP',

      contact: 'CUSTOM_EVENT_2',
      customize_product: 'CUSTOM_EVENT_3',
      donate: 'SPENT_CREDITS',
      find_location: 'SEARCH',
      schedule: 'CUSTOM_EVENT_4',
      start_trial: 'START_TRIAL',
      submit_application: 'SUBSCRIBE',
      subscribe: 'SUBSCRIBE',

      'gtm4wp.addProductToCartEEC': 'ADD_CART',
      'gtm4wp.productClickEEC': 'VIEW_CONTENT',
      'gtm4wp.checkoutOptionEEC': 'START_CHECKOUT',
      'gtm4wp.checkoutStepEEC': 'ADD_BILLING',
      'gtm4wp.orderCompletedEEC': 'PURCHASE'
    };

    if (!gaToEventName[eventName]) {
      return eventName;
    }

    return gaToEventName[eventName];
  }

  return data.eventType === 'standard' ? data.eventNameStandard : data.eventNameCustom;
}

function mapEvent(eventData, data) {
  let mappedData = {
    version: '3.0',
    user_data: {},
    custom_data: {}
  };

  mappedData = addServerData(eventData, mappedData);
  mappedData = addUserData(eventData, mappedData);
  mappedData = addCustomData(eventData, mappedData);
  mappedData = addAppData(eventData, mappedData);
  mappedData = hashDataIfNeeded(mappedData);

  return mappedData;
}

function addCustomData(eventData, mappedData) {
  let currencyFromItems = '';
  let valueFromItems = 0;

  if (eventData.items && eventData.items[0]) {
    mappedData.custom_data.contents = [];
    mappedData.custom_data.content_type = 'product';
    currencyFromItems = eventData.items[0].currency;
    mappedData.custom_data.num_items = eventData.items.length;

    if (!eventData.items[1]) {
      if (eventData.items[0].item_name) mappedData.custom_data.content_name = eventData.items[0].item_name;
      if (eventData.items[0].item_category) mappedData.custom_data.content_category = eventData.items[0].item_category;
      if (eventData.items[0].item_id) mappedData.custom_data.content_ids = eventData.items[0].item_id;

      if (eventData.items[0].price) {
        mappedData.custom_data.value = eventData.items[0].quantity
          ? eventData.items[0].quantity * eventData.items[0].price
          : eventData.items[0].price;
      }
    }

    const itemIdKey = data.itemIdKey ? data.itemIdKey : 'item_id';
    eventData.items.forEach((d, i) => {
      let content = {};
      if (d[itemIdKey]) content.id = d[itemIdKey];
      if (d.quantity) content.quantity = d.quantity;
      if (d.delivery_category) content.delivery_category = d.delivery_category;

      if (d.price) {
        content.item_price = makeNumber(d.price);
        valueFromItems += d.quantity ? d.quantity * content.item_price : content.item_price;
      }

      mappedData.custom_data.contents.push(content);
    });
  }

  if (eventData['x-ga-mp1-ev']) mappedData.custom_data.value = eventData['x-ga-mp1-ev'];
  else if (eventData['x-ga-mp1-tr']) mappedData.custom_data.value = eventData['x-ga-mp1-tr'];
  else if (eventData.value) mappedData.custom_data.value = eventData.value;

  if (eventData.currency) mappedData.custom_data.currency = eventData.currency;
  else if (currencyFromItems) mappedData.custom_data.currency = currencyFromItems;

  if (eventData.search_term) mappedData.custom_data.search_string = eventData.search_term;

  if (eventData.transaction_id) mappedData.custom_data.order_id = eventData.transaction_id;

  if (mappedData.event_name === 'Purchase') {
    if (!mappedData.custom_data.currency) mappedData.custom_data.currency = 'USD';
    if (!mappedData.custom_data.value) mappedData.custom_data.value = valueFromItems ? valueFromItems : 0;
  }
  if (eventData.predicted_ltv) mappedData.custom_data.predicted_ltv = eventData.predicted_ltv;
  if (eventData.sign_up_method) mappedData.custom_data.sign_up_method = eventData.sign_up_method;
  if (eventData.brands) mappedData.custom_data.brands = eventData.brands;

  if (data.customDataList) {
    data.customDataList.forEach((d) => {
      if (isValidValue(d.value)) {
        mappedData.custom_data[d.name] = d.value;
      }
    });
  }

  return mappedData;
}

function addAppData(eventData, mappedData) {
  if (data.eventConversionType !== 'MOBILE_APP') return mappedData;
  const appData = eventData.app_data || {};
  mappedData.app_data = {};

  const appId = data.appId || appData.app_id;
  if (appId) mappedData.app_data.app_id = appId;

  const extinfo = data.extinfo || appData.extinfo;
  if (extinfo) mappedData.app_data.extinfo = extinfo;

  const advertiser_tracking_enabled = data.advertiserTrackingEnabled || appData.advertiser_tracking_enabled;
  if (advertiser_tracking_enabled) mappedData.app_data.advertiser_tracking_enabled = advertiser_tracking_enabled;

  if (data.appDataList) {
    data.appDataList.forEach((d) => {
      if (isValidValue(d.value)) {
        mappedData.app_data[d.name] = d.value;
      }
    });
  }

  return mappedData;
}

function addServerData(eventData, mappedData) {
  mappedData.event_name = getEventName(eventData, data);
  mappedData.event_time = Math.round(getTimestampMillis() / 1000);
  mappedData.action_source = data.eventConversionType;
  mappedData.test_event_code = data.testEventCode;
  mappedData.integration = 'stape';

  if (data.eventConversionType === 'WEB') {
    mappedData.event_source_url = eventData.page_location || getRequestHeader('referer');
  }

  const eventId = eventData.event_id || eventData.transaction_id;
  if (eventId) mappedData.event_id = eventId;
  if (eventData.test_event_code) mappedData.test_event_code = eventData.test_event_code;

  if (data.serverDataList) {
    data.serverDataList.forEach((d) => {
      if (isValidValue(d.value)) {
        mappedData[d.name] = d.value;
      }
    });
  }

  return mappedData;
}

function isHashed(value) {
  if (!value) {
    return false;
  }

  return makeString(value).match('^[A-Fa-f0-9]{64}$') !== null;
}

function hashData(value) {
  if (!value) {
    return value;
  }

  const type = getType(value);

  if (type === 'undefined' || value === 'undefined') {
    return undefined;
  }

  if (type === 'object') {
    return value.map((val) => {
      return hashData(val);
    });
  }

  if (isHashed(value)) {
    return value;
  }

  return sha256Sync(makeString(value).trim().toLowerCase(), {
    outputEncoding: 'hex'
  });
}

function hashDataIfNeeded(mappedData) {
  const fieldsToHash = ['em', 'ph', 'fn', 'ln', 'ge', 'ct', 'st', 'zp', 'country', 'external_id'];
  for (let key in mappedData.user_data) {
    if (fieldsToHash.indexOf(key) !== -1) {
      mappedData.user_data[key] = hashData(mappedData.user_data[key]);
    }
  }
  return mappedData;
}

function addUserData(eventData, mappedData) {
  let address = {};
  let user_data = {};
  if (getType(eventData.user_data) === 'object') {
    user_data = eventData.user_data;
    const addressType = getType(user_data.address);
    if (addressType === 'object' || addressType === 'array') {
      address = user_data.address[0] || user_data.address;
    }
  }
  const click_id = getClickId();
  if (click_id) mappedData.user_data.sc_click_id = click_id;
  const scid = getSCID();
  if (scid) mappedData.user_data.sc_cookie1 = scid;

  if (eventData.anon_id) mappedData.user_data.anon_id = eventData.anon_id;
  if (eventData.madid) mappedData.user_data.madid = eventData.madid;
  if (eventData.download_id) mappedData.user_data.download_id = eventData.download_id;
  if (eventData.user_agent) mappedData.user_data.client_user_agent = eventData.user_agent;
  if (eventData.idfv) mappedData.user_data.idfv = eventData.idfv;

  if (eventData.external_id) mappedData.user_data.external_id = eventData.external_id;
  else if (eventData.user_id) mappedData.user_data.external_id = eventData.user_id;
  else if (eventData.userId) mappedData.user_data.external_id = eventData.userId;

  if (eventData.subscription_id) mappedData.user_data.subscription_id = eventData.subscription_id;
  else if (eventData.subscriptionId) mappedData.user_data.subscription_id = eventData.subscriptionId;

  if (eventData.lead_id) mappedData.user_data.lead_id = eventData.lead_id;
  else if (eventData.leadId) mappedData.user_data.lead_id = eventData.leadId;

  if (eventData.lastName) mappedData.user_data.ln = eventData.lastName;
  else if (eventData.LastName) mappedData.user_data.ln = eventData.LastName;
  else if (eventData.nameLast) mappedData.user_data.ln = eventData.nameLast;
  else if (eventData.last_name) mappedData.user_data.ln = eventData.last_name;
  else if (user_data.last_name) mappedData.user_data.ln = user_data.last_name;
  else if (address.last_name) mappedData.user_data.ln = address.last_name;

  if (eventData.firstName) mappedData.user_data.fn = eventData.firstName;
  else if (eventData.FirstName) mappedData.user_data.fn = eventData.FirstName;
  else if (eventData.nameFirst) mappedData.user_data.fn = eventData.nameFirst;
  else if (eventData.first_name) mappedData.user_data.fn = eventData.first_name;
  else if (user_data.first_name) mappedData.user_data.fn = user_data.first_name;
  else if (address.first_name) mappedData.user_data.fn = address.first_name;

  if (eventData.email) mappedData.user_data.em = eventData.email;
  else if (user_data.email_address) mappedData.user_data.em = user_data.email_address;
  else if (user_data.email) mappedData.user_data.em = user_data.email;

  if (eventData.phone) mappedData.user_data.ph = eventData.phone;
  else if (user_data.phone_number) mappedData.user_data.ph = user_data.phone_number;

  if (eventData.city) mappedData.user_data.ct = eventData.city;
  else if (address.city) mappedData.user_data.ct = address.city;

  if (eventData.state) mappedData.user_data.st = eventData.state;
  else if (eventData.region) mappedData.user_data.st = eventData.region;
  else if (user_data.region) mappedData.user_data.st = user_data.region;
  else if (address.region) mappedData.user_data.st = address.region;

  if (eventData.zip) mappedData.user_data.zp = eventData.zip;
  else if (eventData.postal_code) mappedData.user_data.zp = eventData.postal_code;
  else if (user_data.postal_code) mappedData.user_data.zp = user_data.postal_code;
  else if (address.postal_code) mappedData.user_data.zp = address.postal_code;

  if (eventData.countryCode) mappedData.user_data.country = eventData.countryCode;
  else if (eventData.country) mappedData.user_data.country = eventData.country;
  else if (user_data.country) mappedData.user_data.country = user_data.country;
  else if (address.country) mappedData.user_data.country = address.country;

  if (eventData.gender) mappedData.user_data.ge = eventData.gender;

  if (eventData.ip_override) {
    mappedData.user_data.client_ip_address = eventData.ip_override.split(' ').join('').split(',')[0];
  }

  if (data.userDataList) {
    data.userDataList.forEach((d) => {
      if (isValidValue(d.value)) {
        mappedData.user_data[d.name] = d.value;
      }
    });
  }

  return mappedData;
}

function determinateIsLoggingEnabled() {
  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}

function createUUID() {
  let len = 36;
  let chars = '0123456789abcdef'.split('');
  let uuid = '';

  for (var i = 0; i < len; i++) {
    if (i == 8 || i == 13 || i == 18 || i == 23) {
      uuid += '-';
    } else if (i == 14) {
      uuid += '4';
    } else {
      uuid += chars[generateRandom(0, chars.length - 1)];
    }
  }
  return uuid;
}

function getSCID() {
  const scidCookie = getCookieValues('_scid')[0] || commonCookie._scid;

  if (scidCookie) {
    return scidCookie;
  }

  if (eventData._scid) {
    return eventData._scid;
  }

  if (eventData.scid) {
    return eventData.scid;
  }

  if (data.eventConversionType === 'WEB') {
    return createUUID();
  }

  return undefined;
}

function getClickId() {
  if (eventData.click_id) return eventData.click_id;
  const parsedUrl = parseUrl(url);
  if (parsedUrl && parsedUrl.searchParams.ScCid) {
    return parsedUrl.searchParams.ScCid;
  }
  return getCookieValues('_scclid')[0] || commonCookie._scclid;
}

function isConsentGivenOrNotRequired() {
  if (data.adStorageConsent !== 'required') return true;
  if (eventData.consent_state) return !!eventData.consent_state.ad_storage;
  const xGaGcs = eventData['x-ga-gcs'] || ''; // x-ga-gcs is a string like "G110"
  return xGaGcs[2] === '1';
}

function isValidValue(value) {
  const valueType = getType(value);
  return valueType !== 'null' && valueType !== 'undefined' && value !== '';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_scid"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_scclid"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://tr.snapchat.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_scid"
              },
              {
                "type": 1,
                "string": "_scclid"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Browser ID cookie must NOT be set if checkbox is enabled
  code: |-
    const setCookie = require('setCookie');

    mockData.notSetBrowserIdCookie = true;

    const scidValue = 'scid';
    mock('getAllEventData', {
      event_name: 'purchase',
      eventConversionType: 'WEB',
      _scid: scidValue,
      //click_id: 'clickid'
    });


    mock('setCookie', (name, value, options, encode) => {
      if (name === '_scid' && value === scidValue) fail('_scid cookie must not be set when the checkbox is enabled.');
    });

    runCode(mockData);
- name: Browser ID cookie must be set if checkbox is disabled
  code: |-
    const setCookie = require('setCookie');

    const scidValue = 'scid';
    mock('getAllEventData', {
      event_name: 'purchase',
      eventConversionType: 'WEB',
      _scid: scidValue,
    });


    mock('setCookie', (name, value, options, encode) => {
      assertThat(name).isEqualTo('_scid');
      assertThat(value).isEqualTo(scidValue);
    });

    runCode(mockData);
setup: |-
  const logToConsole = require('logToConsole');

  const mockData = {
    pixelId: '123123123',
    accessToken: 'accessToken123'
  };


___NOTES___

Created on 03/03/2022, 19:13:03


